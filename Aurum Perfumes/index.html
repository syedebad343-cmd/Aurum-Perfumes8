<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Aurum Perfumes — Store & Admin</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
<style>
  :root{
    --bg: #f6f8fb;
    --card:#fff;
    --text:#0f1724;
    --muted:#6b7280;
    --primary:#b8860b; /* goldish default */
    --accent:#f59e0b;
    --border:#e6e9ee;
    --success:#10b981;
    --danger:#ef4444;
    --hero-overlay: rgba(0,0,0,0.36);
  }
  [data-theme="dark"]{
    --bg:#071022; --card:#0f1724; --text:#e6eef8; --muted:#9aa6b2; --border:#1f2937;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:var(--bg);color:var(--text);-webkit-font-smoothing:antialiased}
  a{color:inherit}
  .wrap{max-width:1200px;margin:26px auto;padding:18px}
  /* header */
  .top{display:flex;align-items:center;justify-content:space-between;gap:12px}
  .brand{display:flex;align-items:center;gap:12px}
  .logo{width:58px;height:58px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-weight:800;background:linear-gradient(135deg,var(--accent),#f97316);color:#1f1f1f}
  .brand h1{margin:0;font-size:20px}
  .controls{display:flex;align-items:center;gap:8px}
  .btn{padding:8px 12px;border-radius:8px;border:1px solid var(--border);background:var(--card);cursor:pointer}
  .btn-primary{background:var(--primary);color:white;border:none}
  .small{font-size:13px;color:var(--muted)}

  /* hero */
  .hero{margin-top:16px;border-radius:12px;overflow:hidden;position:relative;min-height:220px;display:flex;align-items:center;padding:28px;background:linear-gradient(90deg,rgba(0,0,0,0.35),rgba(0,0,0,0.25))}
  .hero .hero-bg{position:absolute;inset:0;background-position:center;background-size:cover;filter:brightness(0.55);opacity:0.95}
  .hero .content{position:relative; z-index:2;max-width:650px;color:white}
  .hero h2{margin:0;font-size:34px;letter-spacing:0.6px}
  .hero p{margin:8px 0 14px 0;color:rgba(255,255,255,0.9)}
  .hero .cta{display:flex;gap:10px}

  /* layout */
  .grid-2{display:grid;grid-template-columns:1fr 340px;gap:20px;margin-top:20px}
  @media (max-width:980px){ .grid-2{grid-template-columns:1fr} .hero{min-height:160px;padding:18px} }

  /* product grid */
  .products{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:16px}
  .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:12px;display:flex;flex-direction:column;box-shadow:0 6px 18px rgba(15,23,36,0.04)}
  .img{height:180px;border-radius:10px;background:linear-gradient(180deg,#f3f4f6,#fff);display:flex;align-items:center;justify-content:center;overflow:hidden}
  .card h3{margin:10px 0 6px 0;font-size:16px}
  .muted{color:var(--muted);font-size:13px}
  .controls-row{display:flex;gap:8px;align-items:center;margin-top:auto}
  .select, input[type="number"], input[type="text"]{padding:8px;border-radius:8px;border:1px solid var(--border);background:transparent;color:var(--text)}

  /* sidebar cards */
  .card-side{background:var(--card);border:1px solid var(--border);padding:12px;border-radius:10px;margin-bottom:12px}

  /* admin */
  .admin-wrapper{display:flex;gap:14px}
  .sidebar{width:220px;background:var(--card);border:1px solid var(--border);border-radius:10px;padding:12px}
  .sidebar button{display:block;width:100%;text-align:left;padding:10px;border:none;background:transparent;border-radius:8px;cursor:pointer}
  .sidebar button.active{background:linear-gradient(90deg,var(--primary),#3aa0ff33);color:var(--primary)}
  .admin-main{flex:1}

  /* tables */
  table{width:100%;border-collapse:collapse}
  th,td{padding:8px;border-bottom:1px solid var(--border);text-align:left}

  /* helper */
  .muted-sm{font-size:12px;color:var(--muted)}
  .wa-floating{position:fixed;right:18px;bottom:18px;background:#25D366;color:white;padding:12px;border-radius:50%;box-shadow:0 6px 18px rgba(0,0,0,0.18);text-decoration:none;display:flex;align-items:center;justify-content:center}
  .file-preview{max-height:120px;max-width:100%;border-radius:8px;display:block;margin-top:8px}
  .center{display:flex;align-items:center;justify-content:center}
</style>
</head>
<body>

<div class="wrap" id="app">
  <div class="top">
    <div class="brand">
      <div class="logo">A</div>
      <div>
        <h1 id="site-title">Aurum Perfumes</h1>
        <div id="site-links" class="small muted-sm">Home · Contact</div>
      </div>
    </div>
    <div class="controls">
      <div id="product-count" class="small muted-sm"></div>
      <button class="btn" id="btn-store">Store</button>
      <button class="btn" id="btn-admin">Admin</button>
      <button class="btn" id="btn-theme">Theme</button>
    </div>
  </div>

  <!-- HERO -->
  <div id="hero" class="hero" style="margin-top:18px;">
    <div class="hero-bg" id="hero-bg" style="background-image:linear-gradient(180deg,var(--hero-overlay),var(--hero-overlay)), linear-gradient(90deg,#0000,#0000)"></div>
    <div class="content">
      <h2 id="hero-title">Luxury Perfumes — Aurum</h2>
      <p id="hero-sub">Exclusive scents crafted for timeless elegance. Choose your size and order on WhatsApp instantly.</p>
      <div class="cta">
        <button class="btn-primary" id="hero-shop">Shop Now</button>
        <button class="btn" id="hero-contact">Contact</button>
      </div>
    </div>
  </div>

  <!-- MAIN GRID -->
  <div class="grid-2">
    <div>
      <!-- store/admin views render here -->
      <div id="view"></div>
    </div>

    <aside>
      <div class="card-side">
        <div class="small muted-sm">WhatsApp</div>
        <div style="font-weight:700;margin-top:6px">+92 310 2155721</div>
        <a id="wa-quick" class="wa-floating" href="#" target="_blank" title="WhatsApp">WA</a>
      </div>

      <div class="card-side">
        <div class="small muted-sm">Quick Stats</div>
        <div style="display:flex;gap:10px;margin-top:8px;flex-wrap:wrap">
          <div style="background:var(--card);padding:8px;border-radius:8px;border:1px solid var(--border)">
            <div class="muted-sm">Products</div>
            <div id="stat-products" style="font-weight:700">0</div>
          </div>
          <div style="background:var(--card);padding:8px;border-radius:8px;border:1px solid var(--border)">
            <div class="muted-sm">Orders</div>
            <div id="stat-orders" style="font-weight:700">0</div>
          </div>
        </div>
      </div>

      <div class="card-side">
        <div class="small muted-sm">Theme</div>
        <div style="margin-top:8px"><img id="preview-hero" class="file-preview" src="" alt="" style="display:none"></div>
        <div id="current-theme" class="muted-sm" style="margin-top:8px">Primary: <span id="current-primary">#b8860b</span></div>
      </div>
    </aside>
  </div>

  <footer style="margin-top:22px;border-top:1px solid var(--border);padding-top:14px">
    <div id="footer-text" class="muted-sm">© Aurum Perfumes</div>
  </footer>
</div>

<script>
/* ---------- App Config & State ---------- */
const WHATSAPP_NUMBER = '+923102155721';
const DEFAULT_ADMIN_PW = 'admin';

function lsGet(k,d){ try{ return JSON.parse(localStorage.getItem(k)) ?? d }catch{ return d } }
function lsSet(k,v){ try{ localStorage.setItem(k, JSON.stringify(v)) }catch{} }

let state = {
  products: lsGet('aurum_products', [
    {id: 'p1', name:'Signature Scent', desc:'Warm amber with floral notes', price: 2000, image: null},
    {id: 'p2', name:'Ocean Mist', desc:'Fresh aquatic fragrance', price: 1800, image: null}
  ]),
  coupons: lsGet('aurum_coupons', [{code:'AURUM10', percent:10}]),
  orders: lsGet('aurum_orders', []),
  settings: lsGet('aurum_settings', {siteTitle:'Aurum Perfumes', heroTitle:'Luxury Perfumes — Aurum', heroSub:'Exclusive scents crafted for timeless elegance.', footerText:'© Aurum Perfumes', primary:'#b8860b', heroImage:null}),
  adminPassword: lsGet('aurum_admin_pw', DEFAULT_ADMIN_PW),
  isAdmin: lsGet('aurum_isAdmin', false),
  view: lsGet('aurum_view','store')
};
function persist(){ lsSet('aurum_products', state.products); lsSet('aurum_coupons', state.coupons); lsSet('aurum_orders', state.orders); lsSet('aurum_settings', state.settings); lsSet('aurum_admin_pw', state.adminPassword); lsSet('aurum_isAdmin', state.isAdmin); lsSet('aurum_view', state.view); }

/* ---------- Helpers ---------- */
function uid(prefix='id'){ return prefix + '-' + Math.random().toString(36).slice(2,9) }
function formatRs(n){ return 'Rs ' + Number(n).toLocaleString() }
function el(q){ return document.querySelector(q) }
function elAll(q){ return Array.from(document.querySelectorAll(q)) }

/* ---------- UI Init ---------- */
const viewEl = el('#view');
const productCountEl = el('#product-count');
const statProducts = el('#stat-products');
const statOrders = el('#stat-orders');
const siteTitleEl = el('#site-title');
const siteLinksEl = el('#site-links');
const footerTextEl = el('#footer-text');
const heroBgEl = el('#hero-bg');
const previewHero = el('#preview-hero');
const currentPrimary = el('#current-primary');
const waQuick = el('#wa-quick');

function applySettingsToUI(){
  siteTitleEl.textContent = state.settings.siteTitle || 'Aurum Perfumes';
  siteLinksEl.textContent = (state.settings.links && state.settings.links.join(' · ')) || 'Home · Contact';
  footerTextEl.textContent = state.settings.footerText || '© Aurum Perfumes';
  document.documentElement.style.setProperty('--primary', state.settings.primary || '#b8860b');
  currentPrimary.textContent = state.settings.primary || '#b8860b';
  if(state.settings.heroImage){
    heroBgEl.style.backgroundImage = `url(${state.settings.heroImage})`;
    previewHero.src = state.settings.heroImage; previewHero.style.display = 'block';
  } else {
    heroBgEl.style.backgroundImage = '';
    previewHero.style.display = 'none';
  }
  productCountEl.textContent = `${state.products.length} products`;
  statProducts.textContent = state.products.length;
  statOrders.textContent = state.orders.length;
  waQuick.href = `https://wa.me/${WHATSAPP_NUMBER.replace(/\D/g,'')}`;
}
applySettingsToUI();

/* ---------- Routing ---------- */
el('#btn-store').addEventListener('click', ()=>{ state.view='store'; persist(); render() });
el('#btn-admin').addEventListener('click', ()=>{ if(state.isAdmin){ state.view='admin'; render() } else { state.view='login'; render() } });
el('#btn-theme').addEventListener('click', ()=>{ state.view='settings'; render() });

/* ---------- Render ---------- */
function render(){
  applySettingsToUI();
  if(state.view==='store') renderStore();
  else if(state.view==='login') renderLogin();
  else if(state.view==='admin') renderAdmin();
  else if(state.view==='settings') renderSettings();
}
render();

/* -------------------- STORE -------------------- */
function renderStore(){
  const html = document.createElement('div');
  html.innerHTML = `
    <div style="display:flex;justify-content:space-between;align-items:center;gap:12px">
      <div>
        <h3 style="margin:0">${state.settings.heroTitle || 'Luxury Perfumes'}</h3>
        <div class="muted-sm">${state.settings.heroSub || ''}</div>
      </div>
      <div style="display:flex;gap:8px">
        <input id="q-search" class="select" placeholder="Search products..." style="min-width:220px"/>
        <select id="filter-size" class="select"><option value="">All</option><option value="100mg">100mg</option><option value="50mg">50mg</option></select>
      </div>
    </div>

    <div style="margin-top:16px" id="products-area"></div>
  `;
  viewEl.innerHTML = ''; viewEl.appendChild(html);

  el('#q-search').addEventListener('input', ()=>renderProducts());
  el('#filter-size').addEventListener('change', ()=>renderProducts());

  document.getElementById('hero-shop').onclick = ()=> window.scrollTo({top: document.querySelector('#products-area').offsetTop - 60, behavior:'smooth'});

  renderProducts();
}

function renderProducts(){
  const area = el('#products-area');
  area.innerHTML = `<div class="products"></div>`;
  const grid = area.querySelector('.products');
  const q = el('#q-search').value.trim().toLowerCase();
  const filterSize = el('#filter-size').value;

  state.products.forEach(p=>{
    if(q && !(`${p.name} ${p.desc}`.toLowerCase().includes(q))) return;
    // product card
    const card = document.createElement('div'); card.className = 'card';
    card.innerHTML = `
      <div class="img">${p.image? `<img src="${p.image}" style="width:100%;height:100%;object-fit:cover;border-radius:8px">` : '<div class="muted-sm">No image</div>'}</div>
      <h3>${escapeHtml(p.name)}</h3>
      <div class="muted">${escapeHtml(p.desc)}</div>

      <label class="muted-sm">Size</label>
      <select class="select size" data-id="${p.id}">
        <option value="100mg">100mg</option>
        <option value="50mg">50mg (half)</option>
      </select>

      <label class="muted-sm">Quantity</label>
      <input type="number" min="1" value="1" class="select qty" data-id="${p.id}"/>

      <label class="muted-sm">Coupon (optional)</label>
      <input type="text" placeholder="code" class="select coupon" data-id="${p.id}">

      <div style="display:flex;justify-content:space-between;align-items:center;margin-top:10px">
        <div><div class="muted-sm">Price</div><div class="price" id="price-${p.id}">${formatRs(p.price)}</div></div>
        <div style="display:flex;flex-direction:column;gap:8px">
          <button class="btn btn-primary buy" data-id="${p.id}">Buy (WhatsApp)</button>
        </div>
      </div>
    `;
    grid.appendChild(card);
  });

  // hook events
  elAll('.size, .qty, .coupon').forEach(i=>i.addEventListener('input', e=> updatePriceDisplay(e.target.dataset.id)));
  elAll('.buy').forEach(b=> b.addEventListener('click', onBuy));
  // apply filter: if filterSize set, hide cards where selected size not equals filter? We'll just filter products list above by ignoring if user selected size in filter.
  // initial price update
  state.products.forEach(p=> updatePriceDisplay(p.id));
}

function updatePriceDisplay(id){
  const p = state.products.find(x=>x.id===id);
  if(!p) return;
  const size = (el(`.size[data-id="${id}"]`) || {value:'100mg'}).value;
  const qty = Number((el(`.qty[data-id="${id}"]`) || {value:1}).value) || 1;
  const coupon = (el(`.coupon[data-id="${id}"]`) || {value:''}).value.trim();
  const single = calculatePrice(p.price, size, coupon);
  const total = single * qty;
  const priceEl = el(`#price-${id}`);
  if(priceEl) priceEl.textContent = formatRs(total);
}

function calculatePrice(base, size, coupon){
  let price = Number(base) || 0;
  if(size === '50mg') price = Math.round(price/2);
  if(coupon){
    const c = state.coupons.find(x=> x.code.toLowerCase() === coupon.toLowerCase());
    if(c) price = Math.round(price * (100 - Number(c.percent)) / 100);
  }
  return price;
}

function onBuy(e){
  const id = e.currentTarget.dataset.id;
  const p = state.products.find(x=>x.id===id);
  if(!p) return alert('Product not found');
  const size = el(`.size[data-id="${id}"]`).value;
  const qty = Number(el(`.qty[data-id="${id}"]`).value) || 1;
  const coupon = el(`.coupon[data-id="${id}"]`).value.trim();
  const priceSingle = calculatePrice(p.price, size, coupon);
  const total = priceSingle * qty;
  // create order
  const order = { id: uid('ord'), productId: p.id, productName: p.name, size, qty, price: total, coupon: coupon||null, status:'pending', timestamp: new Date().toISOString() };
  state.orders.unshift(order); persist();
  // open whatsapp
  const msg = encodeURIComponent([
    'Aurum Perfumes Order',
    `Product: ${p.name}`,
    `Size: ${size}`,
    `Quantity: ${qty}`,
    `Price: Rs ${total}`,
    `Coupon: ${coupon||'-'}`,
    `Order ID: ${order.id}`
  ].join('\n'));
  window.open(`https://wa.me/${WHATSAPP_NUMBER.replace(/\D/g,'')}?text=${msg}`, '_blank');
  render();
}

/* -------------------- LOGIN -------------------- */
function renderLogin(){
  const node = document.createElement('div'); node.className='card';
  node.innerHTML = `
    <h3>Admin Login</h3>
    <div class="muted-sm">Enter admin password to access dashboard</div>
    <div style="margin-top:10px">
      <input type="password" id="admin-pw" class="select" placeholder="Password">
    </div>
    <div style="margin-top:10px;display:flex;gap:8px">
      <button id="admin-login" class="btn btn-primary">Login</button>
      <button id="admin-cancel" class="btn">Cancel</button>
    </div>
    <div class="muted-sm" style="margin-top:8px">Default password: <strong>admin</strong></div>
  `;
  viewEl.innerHTML=''; viewEl.appendChild(node);
  el('#admin-login').onclick = ()=>{
    const v = el('#admin-pw').value;
    if(v === state.adminPassword){
      state.isAdmin = true; state.view='admin'; persist(); render();
    } else alert('Wrong password');
  };
  el('#admin-cancel').onclick = ()=>{ state.view='store'; render(); }
}

/* -------------------- ADMIN DASHBOARD -------------------- */
function renderAdmin(){
  const root = document.createElement('div'); root.className='admin-wrapper';
  const sidebar = document.createElement('div'); sidebar.className='sidebar';
  const main = document.createElement('div'); main.className='admin-main card';
  sidebar.innerHTML = `
    <div style="font-weight:700;margin-bottom:10px">Admin</div>
    <button data-tab="dashboard" class="active">Dashboard</button>
    <button data-tab="products">Products</button>
    <button data-tab="coupons">Coupons</button>
    <button data-tab="orders">Orders</button>
    <button data-tab="settings">Settings</button>
    <div style="margin-top:12px"><button id="admin-logout" class="btn">Logout</button></div>
  `;
  main.innerHTML = `<div id="admin-main-content"></div>`;
  root.appendChild(sidebar); root.appendChild(main);
  viewEl.innerHTML=''; viewEl.appendChild(root);

  // sidebar events
  sidebar.querySelectorAll('button[data-tab]').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      sidebar.querySelectorAll('button[data-tab]').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      loadAdminTab(btn.dataset.tab);
    });
  });
  el('#admin-logout').addEventListener('click', ()=>{
    if(confirm('Logout?')){ state.isAdmin=false; state.view='store'; persist(); render(); }
  });

  loadAdminTab('dashboard');
}

/* admin tabs */
function loadAdminTab(tab){
  const content = el('#admin-main-content'); content.innerHTML='';
  if(tab==='dashboard'){
    const d = document.createElement('div');
    d.innerHTML = `
      <h3>Dashboard</h3>
      <div style="display:flex;gap:12px;flex-wrap:wrap;margin-top:12px">
        <div class="card-side"><div class="muted-sm">Products</div><div style="font-weight:700">${state.products.length}</div></div>
        <div class="card-side"><div class="muted-sm">Orders</div><div style="font-weight:700">${state.orders.length}</div></div>
        <div class="card-side"><div class="muted-sm">Coupons</div><div style="font-weight:700">${state.coupons.length}</div></div>
      </div>
    `;
    content.appendChild(d);
  }

  if(tab==='products'){
    const d = document.createElement('div');
    d.innerHTML = `<h3>Products</h3><div style="margin-top:10px"><button id="add-product" class="btn btn-primary">Add Product</button></div><div id="prod-list" style="margin-top:12px"></div>`;
    content.appendChild(d);
    renderAdminProducts();
    el('#add-product').onclick = ()=> openProductEditor();
  }

  if(tab==='coupons'){
    const d = document.createElement('div');
    d.innerHTML = `<h3>Coupons</h3>
      <div style="display:flex;gap:8px;margin-top:10px">
        <input id="new-coupon-code" class="select" placeholder="CODE">
        <input id="new-coupon-percent" class="select" placeholder="%">
        <button id="add-coupon" class="btn btn-primary">Add</button>
      </div>
      <div id="coupon-list" style="margin-top:12px"></div>
    `;
    content.appendChild(d);
    el('#add-coupon').onclick = ()=>{
      const code = el('#new-coupon-code').value.trim();
      const pct = Number(el('#new-coupon-percent').value) || 0;
      if(!code || pct<=0) return alert('Invalid coupon');
      state.coupons.unshift({code, percent:pct}); persist(); loadAdminTab('coupons');
    };
    const list = el('#coupon-list');
    state.coupons.forEach(c=>{
      const row = document.createElement('div'); row.className='card-side';
      row.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center"><div><b>${c.code}</b><div class="muted-sm">${c.percent}%</div></div><div><button class="btn" data-code="${c.code}">Remove</button></div></div>`;
      list.appendChild(row);
    });
    list.querySelectorAll('button[data-code]').forEach(b=>b.addEventListener('click', e=>{
      const code = e.currentTarget.dataset.code;
      if(confirm('Remove coupon '+code+'?')){ state.coupons = state.coupons.filter(x=>x.code!==code); persist(); loadAdminTab('coupons'); }
    }));
  }

  if(tab==='orders'){
    const d = document.createElement('div');
    d.innerHTML = `<h3>Orders</h3><div id="orders-list" style="margin-top:10px"></div>`;
    content.appendChild(d);
    const list = el('#orders-list');
    state.orders.forEach(o=>{
      const row = document.createElement('div'); row.className='card-side';
      row.innerHTML = `<div style="display:flex;justify-content:space-between"><div><b>${o.productName}</b><div class="muted-sm">${o.qty} × ${o.size} — ${formatRs(o.price)}</div><div class="muted-sm">${new Date(o.timestamp).toLocaleString()}</div></div><div><select data-id="${o.id}" class="select status"><option>pending</option><option>processing</option><option>delivered</option><option>cancelled</option></select></div></div>`;
      list.appendChild(row);
    });
    list.querySelectorAll('.status').forEach(s=>{
      const o = state.orders.find(x=>x.id===s.dataset.id); if(o) s.value = o.status;
      s.addEventListener('change', e=>{ const id=s.dataset.id; const v=s.value; state.orders = state.orders.map(x=>x.id===id?({...x,status:v}):x); persist(); });
    });
  }

  if(tab==='settings'){
    const d = document.createElement('div');
    d.innerHTML = `
      <h3>Settings</h3>
      <div style="display:grid;gap:8px;margin-top:10px">
        <label>Site title</label><input id="set-title" class="select" value="${escapeHtml(state.settings.siteTitle)}">
        <label>Hero title</label><input id="set-hero-title" class="select" value="${escapeHtml(state.settings.heroTitle)}">
        <label>Hero subtitle</label><input id="set-hero-sub" class="select" value="${escapeHtml(state.settings.heroSub)}">
        <label>Footer text</label><input id="set-footer" class="select" value="${escapeHtml(state.settings.footerText)}">
        <label>Primary color</label><input id="set-primary" type="color" value="${state.settings.primary}" style="height:40px;padding:4px">
        <label>Upload hero image (will be used as hero background)</label>
        <input id="set-hero-file" type="file" accept="image/*">
        <img id="set-hero-preview" class="file-preview" src="${state.settings.heroImage||''}" style="${state.settings.heroImage?'display:block;':'display:none;'}">
        <label>Change admin password</label><input type="password" id="set-admin-pw" class="select" placeholder="New password (leave blank to keep)">
        <div style="display:flex;gap:8px"><button id="save-settings" class="btn btn-primary">Save</button><button id="reset-demo" class="btn">Reset Demo Data</button></div>
      </div>
    `;
    content.appendChild(d);
    // events
    const heroFile = el('#set-hero-file'), preview = el('#set-hero-preview');
    heroFile.addEventListener('change', e=>{
      const f = e.target.files[0]; if(!f) return;
      const r=new FileReader(); r.onload = ev=>{
        preview.src = ev.target.result; preview.style.display='block';
      }; r.readAsDataURL(f);
    });
    el('#save-settings').onclick = ()=>{
      state.settings.siteTitle = el('#set-title').value.trim() || state.settings.siteTitle;
      state.settings.heroTitle = el('#set-hero-title').value.trim() || state.settings.heroTitle;
      state.settings.heroSub = el('#set-hero-sub').value.trim() || state.settings.heroSub;
      state.settings.footerText = el('#set-footer').value.trim() || state.settings.footerText;
      state.settings.primary = el('#set-primary').value;
      // hero image upload if changed
      if(preview.src && preview.src !== state.settings.heroImage){
        state.settings.heroImage = preview.src;
      }
      const np = el('#set-admin-pw').value;
      if(np) state.adminPassword = np;
      persist(); applySettingsToUI(); alert('Saved settings');
    };
    el('#reset-demo').onclick = ()=>{
      if(confirm('This will clear all local demo data and reload. Continue?')){
        localStorage.clear(); location.reload();
      }
    };
  }
}

/* ---------- Admin Products Editor ---------- */
function renderAdminProducts(){
  const list = el('#prod-list');
  list.innerHTML = '';
  state.products.forEach(p=>{
    const row = document.createElement('div'); row.className='card-side';
    row.innerHTML = `
      <div style="display:flex;gap:10px;align-items:center">
        <div style="width:86px;height:86px;border-radius:8px;overflow:hidden;background:#f6f7f8;display:flex;align-items:center;justify-content:center">${p.image?`<img src="${p.image}" style="width:100%;height:100%;object-fit:cover">`:'No Image'}</div>
        <div style="flex:1">
          <div style="font-weight:700">${escapeHtml(p.name)}</div>
          <div class="muted-sm">${escapeHtml(p.desc)}</div>
          <div style="margin-top:6px">${formatRs(p.price)}</div>
        </div>
        <div style="display:flex;flex-direction:column;gap:8px">
          <button class="btn edit" data-id="${p.id}">Edit</button>
          <button class="btn" data-id="${p.id}" data-action="del">Delete</button>
        </div>
      </div>
    `;
    list.appendChild(row);
  });
  list.querySelectorAll('.edit').forEach(b=> b.addEventListener('click', e=>{
    const p = state.products.find(x=>x.id===b.dataset.id); openProductEditor(p);
  }));
  list.querySelectorAll('button[data-action="del"]').forEach(b=> b.addEventListener('click', e=>{
    const id = b.dataset.id; if(confirm('Delete product?')){ state.products = state.products.filter(x=>x.id!==id); persist(); loadAdminTab('products'); render(); }
  }));
}

function openProductEditor(product){
  const isNew = !product;
  const p = isNew ? {id:uid('p'), name:'', desc:'', price:0, image:null} : {...product};
  const container = el('#admin-main-content');
  const card = document.createElement('div'); card.className='card'; card.style.marginBottom='12px';
  card.innerHTML = `
    <h3>${isNew?'Add Product':'Edit Product'}</h3>
    <label>Name</label><input id="pe-name" class="select" value="${escapeHtml(p.name)}">
    <label>Price (Rs)</label><input id="pe-price" class="select" type="number" value="${p.price}">
    <label>Description</label><textarea id="pe-desc" class="select" rows="3">${escapeHtml(p.desc)}</textarea>
    <label>Image</label><input id="pe-image" type="file" accept="image/*">
    <img id="pe-preview" class="file-preview" src="${p.image||''}" style="${p.image?'display:block':'display:none'}">
    <div style="display:flex;gap:8px;margin-top:8px">
      <button id="pe-save" class="btn btn-primary">${isNew?'Add':'Save'}</button>
      <button id="pe-cancel" class="btn">Cancel</button>
    </div>
  `;
  container.prepend(card);
  const fileIn = card.querySelector('#pe-image'), prev = card.querySelector('#pe-preview');
  fileIn.addEventListener('change', e=>{
    const f = e.target.files[0]; if(!f) return;
    const r = new FileReader(); r.onload = ev=>{ p.image = ev.target.result; prev.src = p.image; prev.style.display='block'; }; r.readAsDataURL(f);
  });
  card.querySelector('#pe-save').onclick = ()=>{
    p.name = card.querySelector('#pe-name').value.trim();
    p.price = Number(card.querySelector('#pe-price').value) || 0;
    p.desc = card.querySelector('#pe-desc').value.trim();
    if(!p.name) return alert('Name required');
    if(isNew) state.products.unshift(p); else state.products = state.products.map(x=>x.id===p.id? p: x);
    persist(); loadAdminTab('products'); render();
  };
  card.querySelector('#pe-cancel').onclick = ()=>{ loadAdminTab('products'); render(); };
}

/* ---------- Utilities ---------- */
function escapeHtml(s=''){ return String(s).replace(/[&<>"]/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); }

/* End of script - ensure initial UI is correct */
applySettingsToUI();
render();
</script>

</body>
</html>
